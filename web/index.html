<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title>Unboxing - drio</title>
	<style>
		html,
		body {
			margin: 0;
			padding: 20px;
			background: black;
			display: flex;
			justify-content: center;
			align-items: flex-start;
		}

		canvas {
			display: block;
			border: 0px solid #666;
			max-width: 100%;
			height: auto;
		}
	</style>
</head>

<body>
	<canvas id="canvas" oncontextmenu="event.preventDefault()"></canvas>
	<script src="index.js"></script>
	<script>
		async function initFractal() {
			const canvas = document.getElementById('canvas');

			// Load modularized WASM
			const Module = await WasmModule();
			console.log('WASM module loaded');

			const config = {
				iterations: 1000000,
				layers: 7,
				palette: 6, // GREY
				width: 800,
				height: 800,
				background: {r: 0, g: 0, b: 0}
			};

			console.log('Generating fractal with config:', config);

			try {
				const seed = Math.floor(Math.random() * 1000000);
				console.log('Using seed:', seed);

				const pixelDataPtr = Module._generate_fractal_pixels(
					config.iterations,
					config.layers,
					config.palette,
					config.width,
					config.height,
					config.background.r,
					config.background.g,
					config.background.b,
					seed
				);

				console.log("Got fractal pixels at pointer:", pixelDataPtr);

				// Get the pixel data from WASM memory
				const pixelCount = config.width * config.height * 4;
				const pixelData = new Uint8Array(Module.HEAPU8.buffer, pixelDataPtr, pixelCount);

				// Create ImageData and draw to canvas
				canvas.width = config.width;
				canvas.height = config.height;

				const ctx = canvas.getContext('2d');
				const imageData = ctx.createImageData(config.width, config.height);
				imageData.data.set(pixelData);
				ctx.putImageData(imageData, 0, 0);

				// Free the memory
				Module._free_pixel_data(pixelDataPtr);

				console.log('Fractal rendered successfully!');
			} catch (e) {
				console.error('Error generating fractal:', e);
			}
		}

		// Start when page loads
		window.addEventListener('load', initFractal);
	</script>
</body>

</html>
