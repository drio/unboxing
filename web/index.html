<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Unboxing - drio</title>
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            background: black;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        canvas {
            display: block;
            border: 0px solid #666;
            max-width: calc(100vw - 340px);
            max-height: calc(100vh - 60px);
            object-fit: contain;
        }

        .container {
            position: relative;
            width: 100%;
            height: 100vh;
        }

        .canvas-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .controls {
            position: fixed;
            top: 1px;
            right: 0;
            z-index: 1000;
        }

        .controls .lil-gui {
            margin: 0 !important;
            padding: 0 !important;
        }

        #status {
            color: #888;
            margin-top: 10px;
            font-size: 12px;
        }

        .info-panel {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 2000;
            background: rgba(0, 0, 0, 0.6);
            padding: 5px 5px;
            border-radius: 6px;
            backdrop-filter: blur(4px);
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .attribution {
            font-size: 11px;
            color: #ccc;
        }

        .attribution a {
            color: #fff;
            text-decoration: none;
        }

        .attribution a:hover {
            color: #ddd;
        }

        .timing {
            font-size: 10px;
            color: #bbb;
            text-align: right;
        }

        .repo-link {
            font-size: 10px;
            color: #999;
            text-align: right;
        }

        .repo-link a {
            color: #aaa;
            text-decoration: none;
            display: inline-block;
            transition: transform 0.2s ease;
        }

        .repo-link a:hover {
            color: #fff;
            transform: scale(1.1);
        }
    </style>
</head>

<body>
    <div class="info-panel">
        <div class="attribution">
            Made with ‚ù§Ô∏è by <a href="https://drio.sh" target="_blank">drio</a>
        </div>
        <div class="repo-link"><a href="https://github.com/drio/unboxing" target="_blank"
                title="View source on GitHub">source</a>
        </div>
        <div class="timing" id="timing"></div>
    </div>
    <div class="container">
        <div class="canvas-container">
            <canvas id="canvas" oncontextmenu="event.preventDefault()"></canvas>
            <div id="status">Ready to generate fractal...</div>
        </div>
        <div class="controls" id="controls"></div>
    </div>
    <script src="index.js"></script>
    <script type="module">
        import GUI from 'https://cdn.jsdelivr.net/npm/lil-gui@0.20/+esm';

        let Module = null;
        let isGenerating = false;

        // Configuration object for lil-gui
        const config = {
            iterations: 10000000,
            layers: 7,
            palette: 1,
            width: 4000,
            height: 4000,
            seed: Math.floor(Math.random() * 1000000),
            backgroundColor: '#000000',
            generate: function () {
                generateFractal();
            },
            randomSeed: function () {
                config.seed = Math.floor(Math.random() * 1000000);
                gui.controllersRecursive().forEach(controller => {
                    if (controller.property === 'seed') {
                        controller.updateDisplay();
                    }
                });
            },
            download: function () {
                downloadImage();
            }
        };

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        let hasValidImage = false;

        function downloadImage() {
            const canvas = document.getElementById('canvas');
            if (!hasValidImage || !canvas.width || !canvas.height) {
                updateStatus('No image to download. Generate a fractal first.');
                return;
            }

            try {
                const link = document.createElement('a');
                link.download = `fractal-${config.palette}-${config.layers}-${config.seed}.png`;
                link.href = canvas.toDataURL();
                link.click();
                updateStatus('Image downloaded successfully!');
            } catch (e) {
                console.error('Error downloading image:', e);
                updateStatus('Error downloading image: ' + e.message);
            }
        }

        async function generateFractal() {
            if (isGenerating) return;

            isGenerating = true;
            updateStatus('Generating fractal...');

            // Allow UI to update before starting heavy computation
            await new Promise(resolve => setTimeout(resolve, 10));

            const startTime = performance.now();
            const canvas = document.getElementById('canvas');

            try {
                console.log('Generating fractal with config:', config);

                // Convert hex color to RGB
                const hex = config.backgroundColor.replace('#', '');
                const r = parseInt(hex.substr(0, 2), 16);
                const g = parseInt(hex.substr(2, 2), 16);
                const b = parseInt(hex.substr(4, 2), 16);

                const pixelDataPtr = Module._generate_fractal_pixels(
                    config.iterations,
                    config.layers,
                    config.palette,
                    config.width,
                    config.height,
                    r,
                    g,
                    b,
                    config.seed
                );

                console.log("Got fractal pixels at pointer:", pixelDataPtr);

                // Get the pixel data from WASM memory
                const pixelCount = config.width * config.height * 4;
                const pixelData = new Uint8Array(Module.HEAPU8.buffer, pixelDataPtr, pixelCount);

                // Create ImageData and draw to canvas
                canvas.width = config.width;
                canvas.height = config.height;

                const ctx = canvas.getContext('2d');
                const imageData = ctx.createImageData(config.width, config.height);
                imageData.data.set(pixelData);
                ctx.putImageData(imageData, 0, 0);

                Module._free_pixel_data(pixelDataPtr);

                hasValidImage = true;

                const endTime = performance.now();
                const duration = ((endTime - startTime) / 1000).toFixed(2);
                document.getElementById('timing').textContent = `‚ö°Generated in ${duration}s`;

                updateStatus('Fractal generated successfully!');
                console.log('Fractal rendered successfully!');
            } catch (e) {
                console.error('Error generating fractal:', e);
                updateStatus('Error generating fractal: ' + e.message);
            } finally {
                isGenerating = false;
            }
        }

        async function initApp() {
            updateStatus('Loading WASM module...');

            // Load modularized WASM
            Module = await WasmModule();
            console.log('WASM module loaded');

            updateStatus('Setting up controls...');
            setupGUI();

            updateStatus('Ready! Click Generate to create a fractal.');
        }

        function setupGUI() {
            const gui = new GUI({container: document.getElementById('controls')});
            gui.title('Chaos Game Generator (unboxing edition)');

            // Main controls
            gui.add(config, 'iterations', 100000, 50000000, 100000).name('Iterations/Points');
            gui.add(config, 'layers', 1, 20, 1).name('Layers');
            gui.add(config, 'palette', 0, 7, 1).name('Palette');
            gui.add(config, 'seed', 0, 1000000, 1).name('Seed');

            // Action buttons
            gui.add(config, 'randomSeed').name('Random Seed');
            gui.add(config, 'generate').name('üé® Generate');
            gui.add(config, 'download').name('üíæ Download PNG');

            // Image settings folder
            const imageFolder = gui.addFolder('Image Settings');
            imageFolder.add(config, 'width', [1000, 2000, 3000, 4000, 5000, 6000]).name('Width');
            imageFolder.add(config, 'height', [1000, 2000, 3000, 4000, 5000, 6000]).name('Height');

            // Background color folder
            const bgFolder = gui.addFolder('Background Color');
            bgFolder.addColor(config, 'backgroundColor').name('Color');

            // Store gui reference globally for seed updates
            window.gui = gui;
        }

        window.addEventListener('load', initApp);
    </script>
</body>

</html>
