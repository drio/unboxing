<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title>Unboxing - 2D Raylib</title>
	<style>
		html,
		body {
			margin: 0;
			padding: 20px;
			background: #333;
			display: flex;
			justify-content: center;
			align-items: flex-start;
		}

		canvas {
			display: block;
			border: 1px solid #666;
			max-width: 100%;
			height: auto;
		}
	</style>
</head>

<body>
	<canvas id="canvas" oncontextmenu="event.preventDefault()"></canvas>
	<script>
		var Module = {
			canvas: document.getElementById('canvas'),
			onRuntimeInitialized: function () {
				const config = {
					iterations: 1000000,
					layers: 7,
					palette: 0, // PALETTE_RED_TO_PINK
					width: 1000,
					height: 1000,
					background: {r: 0, g: 0, b: 0}
				};

				console.log('Generating fractal with config:', config);

				try {
					const pixelDataPtr = Module._generate_fractal_pixels(
						config.iterations,
						config.layers,
						config.palette,
						config.width,
						config.height,
						config.background.r,
						config.background.g,
						config.background.b
					);

					console.log("Got fractal pixels.")

					// Get the pixel data from WASM memory
					const pixelCount = config.width * config.height * 4;
					const pixelData = new Uint8Array(Module.HEAPU8.buffer, pixelDataPtr, pixelCount);

					// Create ImageData and draw to canvas
					const canvas = Module.canvas;
					canvas.width = config.width;
					canvas.height = config.height;

					const ctx = canvas.getContext('2d');
					const imageData = ctx.createImageData(config.width, config.height);
					imageData.data.set(pixelData);
					ctx.putImageData(imageData, 0, 0);

					// Free the memory
					Module._free_pixel_data(pixelDataPtr);

					console.log('Fractal rendered successfully!');
				} catch (e) {
					console.error('Error generating fractal:', e);
				}
			}
		};
	</script>
	<script src="index.js"></script>
</body>

</html>
